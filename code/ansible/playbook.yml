---

- name: Prepare AWS ssh key
  gather_facts: false
  hosts: localhost
  vars:
    ssh_private_key_file: "./ansible_ssh_info"
  tasks:
    - name: Decrypt the key
      ansible.builtin.command:
        cmd: "ansible-vault decrypt {{ ssh_private_key_file }} --output /tmp/ansible_deploy_id"
      register: cmd_output
      changed_when: cmd_output.rc != 0
      no_log: true

- name: Run common role
  hosts: aws_ec2
  gather_facts: false
  roles:
    - common

- name: Run web role on web servers
  hosts: web
  gather_facts: false
  roles:
    - web

- name: Remove the AWS ssh key
  gather_facts: false
  hosts: localhost
  tasks:
    - name: Decrypt the key
      ansible.builtin.command:
        cmd: "rm -f /tmp/ansible_deploy_id"
      register: cmd_output
      changed_when: cmd_output.rc != 0
